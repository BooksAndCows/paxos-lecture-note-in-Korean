# Multi Paxos

## 1. 멀티 팍소스의 구현

팍소스 알고리즘의 목적은 **복제로그의 생성**과 이 로그를 통해 **복제된 상태머신을 생성**하는 것 이라는 것을 Basic Paxos를 통해 배웠다. **멀티 팍소스**는 단 하나의 값을 선출하는** Basic Paxos의 여러 독립적인 사례를 묶어** 로그를 형성하는 연속된 값을 선출해 내는 방식이다. 이러한 멀티 팍소스를 구현하기 위해서는 각각의 Prepare과 Accpet 요청에 변수\(Argument\)를 추가 하면 된다. 그리고 이러한 요청은 특정 로그 항목을 선택하며 모든 서버는 모든 로그의 항목들에 대해 **서버 각자의 독립된 상태**를 갖추고 있다.

> One way to do that, is to use a collection of basic Paxos instances. One independent instance for each of the entries in the log.
>
> So to do this, we just add extra argument to each of the prepare and accept request that selects particular log entry and all of the servers keep separate state for every entry into the log.

![](/assets/Multi Paxos 1.PNG)

위 그림은 클라이언트가 서버에게 명령을 요청을 하면 발생하는 **과정**을 보여주고 있다. 첫번째로 클라이언트가 상태 머신이 실행 시켜 주었으면 하는 **명령**을 서버 중 하나의 팍소스 모듈에게 보낸다. 그럼 그 모듈은 팍소스 프로토콜을 통해 다른 서버들과 소통해 합의를 이끌어내고 클라이언트의 명령이 로그 중 하나의 항목으로 들어갈 수 있게 만들어 준다. 그 후에 로그에 들어간 명령을 상태 머신에 적용하게 되는데 이때 들어간 명령 앞에 있던 다른 명령들이 먼저 로그에 기록되고 상태 머신에 적용되기를 기다린다. 이렇게 상태 머신에 새 명령어가 적용이 되면 그 결과를 클라이언트한테 알려준다.

## 2. 멀티 팍소스를 구현할 때 고려해야 할 점들

멀티 팍소스를 구현할 때에는 어떠한 점들을 고려해야 할까. 여러가지 고려 사항들을 먼저 간단히 알아보고 각 사례에 대해 하나하나씩 자세히 알아보는 시간을 가져보자.

![](/assets/Multi Paxos 2.PNG)

먼저 클라이언트의 요청에 로그 중 **어느 항목을 사용**해야 할까 라는 점이 첫번째 고려사항이다. 로그에는 다양한 항목들이 들어 갈 수 있는 공간이 있고 이러한 공간을 어떻게 어떤 순서로 항목들을 넣어야할지 생각해 봐야 할 것이다. 그 다음 고려 사항은 **성능의 최적화**에 관한 것 이다. 전에 사용했던 Basic 팍소스의 방식을 사용하면 하나의 합의를 도출 하는데에도 오랜 시간이 걸리기 때문에 이러한 점들을 해결 하는 방안을 찾아야 할 것이다. 이러한 방안으로서는 **지도자를 선출**해 제안들의 **충돌을 최소화** 시키고 준비 **요청 단계를 최소**한으로 줄이는 방안을 사용할 것이다. 그 다음으로 생각해야 할 점은 어떻게 모든 서버가 로그를 **동일하게 일치**시킬 것 이며 서버들이 각자 가지고 있는 로그들이 선택\(Chosen\) 되어진 값인지를 **확인** 할 수 있게 만들어 줘야 할 것이다. 그 다음에는 클라이언트 프로토콜로서 **서버가 다운**이 되더라도\(Crash\) 어떻게 계속해서 작동을 해야 하는지에 대한 방안을 생각 해 볼 것이다. 마지막으로는 서버들이 추가가 되거나 제거가 되는 등 **변화**에 대해 어떻게 안전하게 대처를 해야 할 지 알아볼 것이다.

> 참조: 멀티 팍소스는 Basic 팍소스와 다르게 매우 추상적인 표현들과 구체적으로 설명 되어 있지 않다. 또한 멀티 팍소스를 실제로 적용하는 것에는 위의 여러가지 문제들을 해결 함에 있어서 다양한 방법이 있다. 아래의 설명부터는 이런 다양한 문제점들을 해결하는 방안을 쉽게 설명할 수 있도록 작성하였다.

### 2.1 로그 항목 선택

이제부터 멀티 팍소스를 구현할때 고려해야 할 첫번째 요소인 로그 항목 선택에 대해 알아보자

![](/assets/Multi Paxos 3.PNG)위 그림처럼 서버가 3개가 있다고 가정하자. 그리고 좌측 그림의 s1, s2, s3는 각각의 서버의 로그를 보여준다.  이러한 상황에서 클라이언트에서 s1에게 jmp 요청을 했다고 하자. 이때 서버 s1에 기록된 항목들은 다양한 상황에 있을 수 있는데,  서버는 어떤 항목들은 이미 **선택 완료\(Chosen\)**된 항목들 이라는 것을 알고 있을 수 있다. 예를 들면 위의 그림에서 s1옆에 두껍게 표시된 1,2,6번 항목은 이미 선택이 완료된 항목 된 곳들이다. 이렇게 서버가 어떤 항목이 선택 완료 되었는지 알 수 있는지에 대한 자세한 내용은 향후 더 나오겠지만 여기선 s1이 제안한 명령들이라 선택 완료가 되었는지 알 수 있었다고 가정하자.

s1의 3번 항목같은 경우 서버가 항목으로 **인정\(Accepted\)**한 항목이지만 다른 서버에서도 다들 합의가 완료되어 선택 완료\(Chosen\)가 되었는지는 모르는 경우이다. 물론 우리는 그림을 보고 3개의 서버 중 s1이 3번으로 cmp를 인정했고 s3또한 3번으로 cmp를 인정 함으로서 과반수를 넘었으니 선택 완료 된 것임을 알 수 있으나 서버 s1의 입장에서는 그것을 알 수 없는 상황이다.

그리고 서버 s1의 4,5번 항목엔 아직 인정해 받아들인 값이 없는 상황이지만 s2에선 4번 항목에 sub를 s3에선 5번으로 cmp를 인정한 상태임을 알 수 있다. 이러한 상황에서 새로운 요청이 들어오면 어떻게 되는지 알아보자.

처음으로 s1 서버에 요청이 들어오면, s1은 본인의 로그 번호 중 선택 완료 되지 않은 제일 낮은 번호를 찾는다. 이 경우에는 지금 3번이 아직 인정 된 부분이고 선택 완료가 되지 않았음으로 3번을 찾게 된다. 그리고 그 항목에 새로 들어온 값을 넣어 보려고 시도를 한다.

그럼 잠시 예시를 돕기위해 서버 s3가 없다고 하자. 현재 모든 팍소스들은 서버 s1과 s2만 있다고 하자.

그럼 다시 돌아와서 s1의 3번 항목에 jmp를 넣어 보려고 하지만 이미 cmp 값이 들어가 있기 때문에 3번에 jmp를 넣는건 포기하고 3번 항목을 cmp로 선택 완료 시킬 것 이다. 우측 Logs After 그림을 보면 s1이 s2에게 3번 항목으로 cmp을 요청해  선택 완료 된 값으로 선택 되었음을 볼 수 있다.

